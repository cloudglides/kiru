name: Build Packages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

env:
  APP_NAME: kiru
  APP_VERSION: 1.0.${{ github.run_number }}

permissions:
  contents: write

jobs:
  build-deb:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          /var/cache/apt/archives
          ~/.cache
        key: ${{ runner.os }}-deb-deps-${{ hashFiles('.github/workflows/build.yml') }}
        restore-keys: |
          ${{ runner.os }}-deb-deps-
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gjs \
          libgtk-3-dev \
          libgirepository1.0-dev \
          libsoup2.4-dev \
          cairo-dev \
          pango1.0-dev \
          libgdk-pixbuf2.0-dev \
          libglib2.0-dev \
          gnome-screenshot \
          curl \
          xclip \
          shared-mime-info \
          dpkg-dev
    
    - name: Validate main.js exists
      run: |
        if [ ! -f "main.js" ]; then
          echo "Error: main.js not found!"
          exit 1
        fi
    
    - name: Create package structure
      run: |
        mkdir -p ${{ env.APP_NAME }}/DEBIAN
        mkdir -p ${{ env.APP_NAME }}/usr/bin
        mkdir -p ${{ env.APP_NAME }}/usr/share/applications
        mkdir -p ${{ env.APP_NAME }}/usr/share/icons/hicolor/512x512/apps
        mkdir -p ${{ env.APP_NAME }}/usr/share/doc/${{ env.APP_NAME }}
        
        # Copy application
        cp main.js ${{ env.APP_NAME }}/usr/bin/${{ env.APP_NAME }}
        chmod +x ${{ env.APP_NAME }}/usr/bin/${{ env.APP_NAME }}
        
        # Create DEBIAN/control file
        cat > ${{ env.APP_NAME }}/DEBIAN/control << EOF
        Package: ${{ env.APP_NAME }}
        Version: ${{ env.APP_VERSION }}
        Section: utils
        Priority: optional
        Architecture: amd64
        Depends: gjs, libgtk-3-0, libgirepository-1.0-1, libsoup2.4-1, libcairo2, libpango-1.0-0, libgdk-pixbuf2.0-0, libglib2.0-0, gnome-screenshot, curl, xclip, shared-mime-info
        Maintainer: Your Name <your.email@example.com>
        Description: Screenshot editor application
         A screenshot editor built with GJS and GTK.
        EOF
        
        # Create desktop file
        cat > ${{ env.APP_NAME }}/usr/share/applications/${{ env.APP_NAME }}.desktop << EOF
        [Desktop Entry]
        Name=Kiru
        Comment=Screenshot editor
        Exec=${{ env.APP_NAME }}
        Icon=${{ env.APP_NAME }}
        Type=Application
        Categories=Utility;Graphics;
        Terminal=false
        EOF
        
        # Create copyright file
        cat > ${{ env.APP_NAME }}/usr/share/doc/${{ env.APP_NAME }}/copyright << EOF
        Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
        Upstream-Name: ${{ env.APP_NAME }}
        Source: https://github.com/${{ github.repository }}
        
        Files: *
        Copyright: $(date +%Y) ${{ github.repository_owner }}
        License: MIT
        EOF
        
        # Copy or create placeholder icon
        if [ -f "icon.png" ]; then
          cp icon.png ${{ env.APP_NAME }}/usr/share/icons/hicolor/512x512/apps/${{ env.APP_NAME }}.png
        else
          # Create a minimal PNG placeholder
          convert -size 512x512 xc:blue ${{ env.APP_NAME }}/usr/share/icons/hicolor/512x512/apps/${{ env.APP_NAME }}.png 2>/dev/null || \
          touch ${{ env.APP_NAME }}/usr/share/icons/hicolor/512x512/apps/${{ env.APP_NAME }}.png
        fi
    
    - name: Build DEB package
      run: |
        dpkg-deb --build ${{ env.APP_NAME }}
        mv ${{ env.APP_NAME }}.deb ${{ env.APP_NAME }}_${{ env.APP_VERSION }}_amd64.deb
        
        # Verify package
        dpkg-deb --info ${{ env.APP_NAME }}_${{ env.APP_VERSION }}_amd64.deb
        dpkg-deb --contents ${{ env.APP_NAME }}_${{ env.APP_VERSION }}_amd64.deb
    
    - name: Upload DEB artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-deb
        path: ${{ env.APP_NAME }}_*.deb
        if-no-files-found: error

  build-rpm:
    runs-on: ubuntu-22.04
    container: 
      image: fedora:39
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        dnf update -y
        dnf install -y \
          gjs \
          gtk3-devel \
          gobject-introspection-devel \
          libsoup-devel \
          cairo-devel \
          pango-devel \
          gdk-pixbuf2-devel \
          glib2-devel \
          gnome-screenshot \
          curl \
          xclip \
          shared-mime-info \
          rpm-build \
          rpmdevtools
    
    - name: Setup RPM build environment
      run: |
        rpmdev-setuptree
        mkdir -p ~/rpmbuild/BUILD
        mkdir -p ~/rpmbuild/BUILDROOT
    
    - name: Create package structure
      run: |
        mkdir -p ~/rpmbuild/BUILDROOT/${{ env.APP_NAME }}-${{ env.APP_VERSION }}-1.x86_64/usr/bin
        mkdir -p ~/rpmbuild/BUILDROOT/${{ env.APP_NAME }}-${{ env.APP_VERSION }}-1.x86_64/usr/share/applications
        mkdir -p ~/rpmbuild/BUILDROOT/${{ env.APP_NAME }}-${{ env.APP_VERSION }}-1.x86_64/usr/share/icons/hicolor/512x512/apps
        
        cp main.js ~/rpmbuild/BUILDROOT/${{ env.APP_NAME }}-${{ env.APP_VERSION }}-1.x86_64/usr/bin/${{ env.APP_NAME }}
        chmod +x ~/rpmbuild/BUILDROOT/${{ env.APP_NAME }}-${{ env.APP_VERSION }}-1.x86_64/usr/bin/${{ env.APP_NAME }}
        
        # Desktop file
        cat > ~/rpmbuild/BUILDROOT/${{ env.APP_NAME }}-${{ env.APP_VERSION }}-1.x86_64/usr/share/applications/${{ env.APP_NAME }}.desktop << EOF
        [Desktop Entry]
        Name=Kiru
        Comment=Screenshot editor
        Exec=${{ env.APP_NAME }}
        Icon=${{ env.APP_NAME }}
        Type=Application
        Categories=Utility;Graphics;
        Terminal=false
        EOF
        
        # Placeholder icon
        touch ~/rpmbuild/BUILDROOT/${{ env.APP_NAME }}-${{ env.APP_VERSION }}-1.x86_64/usr/share/icons/hicolor/512x512/apps/${{ env.APP_NAME }}.png
    
    - name: Create RPM spec file
      run: |
        cat > ~/rpmbuild/SPECS/${{ env.APP_NAME }}.spec << EOF
        Name:           ${{ env.APP_NAME }}
        Version:        ${{ env.APP_VERSION }}
        Release:        1%{?dist}
        Summary:        Screenshot editor application
        License:        MIT
        URL:            https://github.com/${{ github.repository }}
        BuildArch:      x86_64
        
        Requires:       gjs gtk3 gobject-introspection libsoup cairo pango gdk-pixbuf2 glib2 gnome-screenshot curl xclip shared-mime-info
        
        %description
        A screenshot editor built with GJS and GTK.
        
        %prep
        # No prep needed
        
        %build
        # No build needed
        
        %install
        # Files already in BUILDROOT
        
        %files
        %attr(0755,root,root) /usr/bin/${{ env.APP_NAME }}
        /usr/share/applications/${{ env.APP_NAME }}.desktop
        /usr/share/icons/hicolor/512x512/apps/${{ env.APP_NAME }}.png
        
        %changelog
        * $(date "+%%a %%b %%d %%Y") GitHub Actions <noreply@github.com> - ${{ env.APP_VERSION }}-1
        - Automated build from commit ${{ github.sha }}
        EOF
    
    - name: Build RPM package
      run: |
        rpmbuild -bb ~/rpmbuild/SPECS/${{ env.APP_NAME }}.spec
        cp ~/rpmbuild/RPMS/x86_64/${{ env.APP_NAME }}-*.rpm .
        
        # Verify package
        rpm -qip ${{ env.APP_NAME }}-*.rpm
        rpm -qlp ${{ env.APP_NAME }}-*.rpm
    
    - name: Upload RPM artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-rpm
        path: ${{ env.APP_NAME }}-*.rpm
        if-no-files-found: error

  build-appimage:
    runs-on: ubuntu-20.04  # Use older Ubuntu for better compatibility
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gjs \
          libgtk-3-0 \
          libgirepository-1.0-1 \
          libsoup2.4-1 \
          libcairo2 \
          libpango-1.0-0 \
          libgdk-pixbuf2.0-0 \
          libglib2.0-0 \
          gnome-screenshot \
          curl \
          xclip \
          shared-mime-info \
          file \
          desktop-file-utils \
          wget
    
    - name: Download appimagetool
      run: |
        wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool
    
    - name: Create AppDir structure
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/lib
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/512x512/apps
        
        # Copy application
        cp main.js AppDir/usr/bin/${{ env.APP_NAME }}
        chmod +x AppDir/usr/bin/${{ env.APP_NAME }}
        
        # Create desktop file
        cat > AppDir/usr/share/applications/${{ env.APP_NAME }}.desktop << EOF
        [Desktop Entry]
        Name=Kiru
        Comment=Screenshot editor
        Exec=${{ env.APP_NAME }}
        Icon=${{ env.APP_NAME }}
        Type=Application
        Categories=Utility;Graphics;
        Terminal=false
        EOF
        
        # Create AppRun script
        cat > AppDir/AppRun << 'EOF'
        #!/bin/bash
        SELF=$(readlink -f "$0")
        HERE=${SELF%/*}
        export PATH="${HERE}/usr/bin:${PATH}"
        export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
        export GI_TYPELIB_PATH="${HERE}/usr/lib/girepository-1.0:${GI_TYPELIB_PATH}"
        exec "${HERE}/usr/bin/${{ env.APP_NAME }}" "$@"
        EOF
        chmod +x AppDir/AppRun
        
        # Copy or create icon
        if [ -f "icon.png" ]; then
          cp icon.png AppDir/usr/share/icons/hicolor/512x512/apps/${{ env.APP_NAME }}.png
          cp icon.png AppDir/${{ env.APP_NAME }}.png
        else
          touch AppDir/usr/share/icons/hicolor/512x512/apps/${{ env.APP_NAME }}.png
          touch AppDir/${{ env.APP_NAME }}.png
        fi
        
        # Symlink for AppImage requirement
        ln -sf usr/share/applications/${{ env.APP_NAME }}.desktop AppDir/${{ env.APP_NAME }}.desktop
    
    - name: Build AppImage
      run: |
        ./appimagetool --comp gzip AppDir ${{ env.APP_NAME }}-${{ env.APP_VERSION }}-x86_64.AppImage
        chmod +x ${{ env.APP_NAME }}-${{ env.APP_VERSION }}-x86_64.AppImage
    
    - name: Upload AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-appimage
        path: ${{ env.APP_NAME }}-*.AppImage
        if-no-files-found: error

  release:
    needs: [build-deb, build-rpm, build-appimage]
    runs-on: ubuntu-22.04
    if: github.event_name == 'release'
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Upload to release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ env.APP_NAME }}-deb/*.deb
          ${{ env.APP_NAME }}-rpm/*.rpm
          ${{ env.APP_NAME }}-appimage/*.AppImage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
