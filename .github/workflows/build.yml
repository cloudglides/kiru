name: Build Packages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-deb:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y gjs libgtk-3-dev libgirepository1.0-dev libsoup2.4-dev cairo-dev pango-dev gdk-pixbuf-dev glib-dev gnome-screenshot curl xclip shared-mime-info
    - name: Create package
      run: |
        mkdir -p kiru/usr/bin
        mkdir -p kiru/usr/share/applications
        mkdir -p kiru/usr/share/icons/hicolor/512x512/apps
        cp main.js kiru/usr/bin/kiru
        chmod +x kiru/usr/bin/kiru
        # Create desktop file
        cat > kiru/usr/share/applications/kiru.desktop << EOF
        [Desktop Entry]
        Name=Kiru
        Exec=kiru
        Icon=kiru
        Type=Application
        Categories=Utility;
        EOF
        # Copy icon (placeholder)
        touch kiru/usr/share/icons/hicolor/512x512/apps/kiru.png
        # Build deb
        sudo apt install -y dpkg-dev
        dpkg-deb --build kiru
        mv kiru.deb kiru_${{ github.run_number }}_amd64.deb
    - uses: actions/upload-artifact@v3
      with:
        name: kiru-deb
        path: kiru_*.deb

  build-rpm:
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
    - uses: actions/checkout@v3
    - name: Install dependencies
      run: |
        dnf update -y
        dnf install -y gjs gtk3-devel gobject-introspection-devel libsoup-devel cairo-devel pango-devel gdk-pixbuf2-devel glib-devel gnome-screenshot curl xclip shared-mime-info rpm-build
    - name: Create package
      run: |
        mkdir -p ~/rpmbuild/SOURCES/kiru/usr/bin
        mkdir -p ~/rpmbuild/SOURCES/kiru/usr/share/applications
        mkdir -p ~/rpmbuild/SOURCES/kiru/usr/share/icons/hicolor/512x512/apps
        cp main.js ~/rpmbuild/SOURCES/kiru/usr/bin/kiru
        chmod +x ~/rpmbuild/SOURCES/kiru/usr/bin/kiru
        # Desktop file
        cat > ~/rpmbuild/SOURCES/kiru/usr/share/applications/kiru.desktop << EOF
        [Desktop Entry]
        Name=Kiru
        Exec=kiru
        Icon=kiru
        Type=Application
        Categories=Utility;
        EOF
        touch ~/rpmbuild/SOURCES/kiru/usr/share/icons/hicolor/512x512/apps/kiru.png
        # Spec file
        cat > kiru.spec << EOF
        Name: kiru
        Version: 1.0
        Release: ${{ github.run_number }}
        Summary: Screenshot editor
        License: MIT
        %description
        Screenshot editor app
        %files
        /usr/bin/kiru
        /usr/share/applications/kiru.desktop
        /usr/share/icons/hicolor/512x512/apps/kiru.png
        EOF
        rpmbuild -bb kiru.spec
        cp ~/rpmbuild/RPMS/x86_64/kiru-*.rpm .
    - uses: actions/upload-artifact@v3
      with:
        name: kiru-rpm
        path: kiru-*.rpm

  build-appimage:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Install appimage-builder
      run: |
        sudo apt update
        sudo apt install -y python3-pip
        pip3 install appimage-builder
    - name: Create AppImage recipe
      run: |
        cat > AppImageBuilder.yml << EOF
        version: 1
        AppDir:
          path: ./AppDir
          app_info:
            id: kiru
            name: Kiru
            icon: kiru
            version: latest
            exec: usr/bin/kiru
            exec_args: \$@
          files:
            include:
              - main.js
            exclude:
              - .git
          runtime:
            env:
              PATH: \$APPDIR/usr/bin:\$PATH
          test:
            fedora-30:
            debian-stable:
            ubuntu-18.04:
            centos-7:
        EOF
        mkdir -p AppDir/usr/bin
        cp main.js AppDir/usr/bin/kiru
        chmod +x AppDir/usr/bin/kiru
    - name: Build AppImage
      run: |
        appimage-builder --recipe AppImageBuilder.yml
    - uses: actions/upload-artifact@v3
      with:
        name: kiru-appimage
        path: *.AppImage
