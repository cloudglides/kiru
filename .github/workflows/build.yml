echo "### Universal (AppImage)" >> release_notes.md
        echo "\`\`\`bash" >> release_notes.md
        echo "chmod +x kiru-*.AppImage" >> release_notes.md
        echo "./kiru-*.AppImage" >> release_notes.md
        echo "\`\`\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${LAST_TAG}...v${{ env.APP_VERSION }}" >> release_notes.md
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ env.APP_VERSION }}
        name: Release v${{ env.APP_VERSION }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          ${{ env.APP_NAME }}-deb/*.deb
          ${{ env.APP_NAME }}-rpm/*.rpm
          ${{ env.APP_NAME }}-appimage/*.AppImage
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Comment on commits
      run: |
        echo "âœ… Release v${{ env.APP_VERSION }} created successfully!"
        echo "ðŸ“¦ Packages available at: https://github.com/${{ github.repository }}/releases/tag/v${{ env.APP_VERSION }}"

  preview-release:
    needs: [build-deb, build-rpm, build-appimage]
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      contents: read
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Generate checksums
      run: |
        cd ${{ env.APP_NAME }}-deb && sha256sum *.deb > ../checksums.txt && cd ..
        cd ${{ env.APP_NAME }}-rpm && sha256sum *.rpm >> ../checksums.txt && cd ..
        cd ${{ env.APP_NAME }}-appimage && sha256sum *.AppImage >> ../checksums.txt && cd ..
    
    - name: Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const checksums = fs.readFileSync('checksums.txt', 'utf8');
          
          const comment = `## ðŸ“¦ Release Preview
          
          Packages built successfully for this PR!
          
          ### Available Packages
          - âœ… Debian/Ubuntu (.deb)
          - âœ… Fedora/RHEL (.rpm)
          - âœ… Universal (AppImage)
          
          ### Checksums (SHA256)
          \`\`\`
          ${checksums}
          \`\`\`
          
          ### Download Artifacts
          You can download the build artifacts from the [Actions run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).
          
          When this PR is merged to main, a release \`v${{ env.APP_VERSION }}\` will be automatically created.`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });name: Build Packages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

env:
  APP_NAME: kiru
  APP_VERSION: 1.0.${{ github.run_number }}

permissions:
  contents: write

jobs:
  build-deb:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          /var/cache/apt/archives
          ~/.cache
        key: ${{ runner.os }}-deb-deps-${{ hashFiles('.github/workflows/build.yml') }}
        restore-keys: |
          ${{ runner.os }}-deb-deps-
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gjs \
          libgtk-3-dev \
          libgirepository1.0-dev \
          libsoup2.4-dev \
          libcairo2-dev \
          libpango1.0-dev \
          libgdk-pixbuf-2.0-dev \
          libglib2.0-dev \
          gnome-screenshot \
          curl \
          xclip \
          shared-mime-info \
          dpkg-dev
    
    - name: Validate main.js exists
      run: |
        if [ ! -f "main.js" ]; then
          echo "Error: main.js not found!"
          exit 1
        fi
    
    - name: Create package structure
      run: |
        mkdir -p ${{ env.APP_NAME }}/DEBIAN
        mkdir -p ${{ env.APP_NAME }}/usr/bin
        mkdir -p ${{ env.APP_NAME }}/usr/share/applications
        mkdir -p ${{ env.APP_NAME }}/usr/share/icons/hicolor/512x512/apps
        mkdir -p ${{ env.APP_NAME }}/usr/share/doc/${{ env.APP_NAME }}
        
        # Copy application
        cp main.js ${{ env.APP_NAME }}/usr/bin/${{ env.APP_NAME }}
        chmod +x ${{ env.APP_NAME }}/usr/bin/${{ env.APP_NAME }}
        
        # Create DEBIAN/control file
        cat > ${{ env.APP_NAME }}/DEBIAN/control << EOF
        Package: ${{ env.APP_NAME }}
        Version: ${{ env.APP_VERSION }}
        Section: utils
        Priority: optional
        Architecture: amd64
        Depends: gjs, libgtk-3-0, libgirepository-1.0-1, libsoup2.4-1, libcairo2, libpango-1.0-0, libgdk-pixbuf2.0-0, libglib2.0-0, gnome-screenshot, curl, xclip, shared-mime-info
        Maintainer: Your Name <your.email@example.com>
        Description: Screenshot editor application
         A screenshot editor built with GJS and GTK.
        EOF
        
        # Create desktop file
        cat > ${{ env.APP_NAME }}/usr/share/applications/${{ env.APP_NAME }}.desktop << EOF
        [Desktop Entry]
        Name=Kiru
        Comment=Screenshot editor
        Exec=${{ env.APP_NAME }}
        Icon=${{ env.APP_NAME }}
        Type=Application
        Categories=Utility;Graphics;
        Terminal=false
        EOF
        
        # Create copyright file
        cat > ${{ env.APP_NAME }}/usr/share/doc/${{ env.APP_NAME }}/copyright << EOF
        Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
        Upstream-Name: ${{ env.APP_NAME }}
        Source: https://github.com/${{ github.repository }}
        
        Files: *
        Copyright: $(date +%Y) ${{ github.repository_owner }}
        License: MIT
        EOF
        
        # Copy or create placeholder icon
        if [ -f "icon.png" ]; then
          cp icon.png ${{ env.APP_NAME }}/usr/share/icons/hicolor/512x512/apps/${{ env.APP_NAME }}.png
        else
          # Create a minimal PNG placeholder
          convert -size 512x512 xc:blue ${{ env.APP_NAME }}/usr/share/icons/hicolor/512x512/apps/${{ env.APP_NAME }}.png 2>/dev/null || \
          touch ${{ env.APP_NAME }}/usr/share/icons/hicolor/512x512/apps/${{ env.APP_NAME }}.png
        fi
    
    - name: Build DEB package
      run: |
        dpkg-deb --build ${{ env.APP_NAME }}
        mv ${{ env.APP_NAME }}.deb ${{ env.APP_NAME }}-${{ env.APP_VERSION }}-amd64.deb
        
        # Verify package
        dpkg-deb --info ${{ env.APP_NAME }}-${{ env.APP_VERSION }}-amd64.deb
        dpkg-deb --contents ${{ env.APP_NAME }}-${{ env.APP_VERSION }}-amd64.deb
    
    - name: Upload DEB artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-deb
        path: ${{ env.APP_NAME }}-*.deb
        if-no-files-found: error

  build-rpm:
    runs-on: ubuntu-22.04
    container: 
      image: fedora:39
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        dnf update -y
        dnf install -y \
          gjs \
          gtk3-devel \
          gobject-introspection-devel \
          libsoup-devel \
          cairo-devel \
          pango-devel \
          gdk-pixbuf2-devel \
          glib2-devel \
          gnome-screenshot \
          curl \
          xclip \
          shared-mime-info \
          rpm-build \
          rpmdevtools
    
    - name: Setup RPM build environment
      run: |
        rpmdev-setuptree
        # Copy source files to SOURCES directory
        cp main.js ~/rpmbuild/SOURCES/
        
        # Create desktop file in SOURCES
        cat > ~/rpmbuild/SOURCES/${{ env.APP_NAME }}.desktop << EOF
        [Desktop Entry]
        Name=Kiru
        Comment=Screenshot editor
        Exec=${{ env.APP_NAME }}
        Icon=${{ env.APP_NAME }}
        Type=Application
        Categories=Utility;Graphics;
        Terminal=false
        EOF
        
        # Create placeholder icon
        touch ~/rpmbuild/SOURCES/${{ env.APP_NAME }}.png
    
    - name: Create RPM spec file
      run: |
        cat > ~/rpmbuild/SPECS/${{ env.APP_NAME }}.spec << 'SPECEOF'
        Name:           kiru
        Version:        1.0.%{getenv:GITHUB_RUN_NUMBER}
        Release:        1%{?dist}
        Summary:        Screenshot editor application
        License:        MIT
        URL:            https://github.com/%{getenv:GITHUB_REPOSITORY}
        BuildArch:      x86_64
        Source0:        main.js
        Source1:        kiru.desktop
        Source2:        kiru.png
        
        Requires:       gjs gtk3 gobject-introspection libsoup cairo pango gdk-pixbuf2 glib2 gnome-screenshot curl xclip shared-mime-info
        
        %description
        A screenshot editor built with GJS and GTK.
        
        %prep
        # No prep needed
        
        %build
        # No build needed
        
        %install
        mkdir -p %{buildroot}/usr/bin
        mkdir -p %{buildroot}/usr/share/applications
        mkdir -p %{buildroot}/usr/share/icons/hicolor/512x512/apps
        
        install -m 0755 %{SOURCE0} %{buildroot}/usr/bin/kiru
        install -m 0644 %{SOURCE1} %{buildroot}/usr/share/applications/kiru.desktop
        install -m 0644 %{SOURCE2} %{buildroot}/usr/share/icons/hicolor/512x512/apps/kiru.png
        
        %files
        %attr(0755,root,root) /usr/bin/kiru
        /usr/share/applications/kiru.desktop
        /usr/share/icons/hicolor/512x512/apps/kiru.png
        
        SPECEOF
    
    - name: Build RPM package
      run: |
        export GITHUB_RUN_NUMBER="${{ github.run_number }}"
        export GITHUB_REPOSITORY="${{ github.repository }}"
        rpmbuild -bb ~/rpmbuild/SPECS/${{ env.APP_NAME }}.spec
        cp ~/rpmbuild/RPMS/x86_64/${{ env.APP_NAME }}-*.rpm .
        
        # Verify package
        rpm -qip ${{ env.APP_NAME }}-*.rpm
        rpm -qlp ${{ env.APP_NAME }}-*.rpm
    
    - name: Upload RPM artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-rpm
        path: ${{ env.APP_NAME }}-*.rpm
        if-no-files-found: error

  build-appimage:
    runs-on: ubuntu-20.04  # Use older Ubuntu for better compatibility
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gjs \
          libgtk-3-0 \
          libgirepository-1.0-1 \
          libsoup2.4-1 \
          libcairo2 \
          libpango-1.0-0 \
          libgdk-pixbuf2.0-0 \
          libglib2.0-0 \
          gnome-screenshot \
          curl \
          xclip \
          shared-mime-info \
          file \
          desktop-file-utils \
          wget
    
    - name: Download appimagetool
      run: |
        wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool
    
    - name: Create AppDir structure
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/lib
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/512x512/apps
        
        # Copy application
        cp main.js AppDir/usr/bin/${{ env.APP_NAME }}
        chmod +x AppDir/usr/bin/${{ env.APP_NAME }}
        
        # Create desktop file
        cat > AppDir/usr/share/applications/${{ env.APP_NAME }}.desktop << EOF
        [Desktop Entry]
        Name=Kiru
        Comment=Screenshot editor
        Exec=${{ env.APP_NAME }}
        Icon=${{ env.APP_NAME }}
        Type=Application
        Categories=Utility;Graphics;
        Terminal=false
        EOF
        
        # Create AppRun script
        cat > AppDir/AppRun << 'EOF'
        #!/bin/bash
        SELF=$(readlink -f "$0")
        HERE=${SELF%/*}
        export PATH="${HERE}/usr/bin:${PATH}"
        export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
        export GI_TYPELIB_PATH="${HERE}/usr/lib/girepository-1.0:${GI_TYPELIB_PATH}"
        exec "${HERE}/usr/bin/${{ env.APP_NAME }}" "$@"
        EOF
        chmod +x AppDir/AppRun
        
        # Copy or create icon
        if [ -f "icon.png" ]; then
          cp icon.png AppDir/usr/share/icons/hicolor/512x512/apps/${{ env.APP_NAME }}.png
          cp icon.png AppDir/${{ env.APP_NAME }}.png
        else
          touch AppDir/usr/share/icons/hicolor/512x512/apps/${{ env.APP_NAME }}.png
          touch AppDir/${{ env.APP_NAME }}.png
        fi
        
        # Symlink for AppImage requirement
        ln -sf usr/share/applications/${{ env.APP_NAME }}.desktop AppDir/${{ env.APP_NAME }}.desktop
    
    - name: Build AppImage
      run: |
        ./appimagetool --comp gzip AppDir ${{ env.APP_NAME }}-${{ env.APP_VERSION }}-x86_64.AppImage
        chmod +x ${{ env.APP_NAME }}-${{ env.APP_VERSION }}-x86_64.AppImage
    
    - name: Upload AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-appimage
        path: ${{ env.APP_NAME }}-*.AppImage
        if-no-files-found: error

  create-release:
    needs: [build-deb, build-rpm, build-appimage]
    runs-on: ubuntu-22.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Generate release notes
      id: release_notes
      run: |
        # Get the last tag, or use initial commit if no tags exist
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || git rev-list --max-parents=0 HEAD)
        
        # Generate changelog
        echo "## What's Changed" > release_notes.md
        echo "" >> release_notes.md
        git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges >> release_notes.md
        echo "" >> release_notes.md
        echo "" >> release_notes.md
        echo "## Package Downloads" >> release_notes.md
        echo "" >> release_notes.md
        echo "### Debian/Ubuntu (.deb)" >> release_notes.md
        echo "\`\`\`bash" >> release_notes.md
        echo "sudo dpkg -i kiru_${{ env.APP_VERSION }}_amd64.deb" >> release_notes.md
        echo "sudo apt-get install -f  # Fix dependencies" >> release_notes.md
        echo "\`\`\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "### Fedora/RHEL (.rpm)" >> release_notes.md
        echo "\`\`\`bash" >> release_notes.md
        echo "sudo dnf install kiru-*.rpm" >> release_notes.md
        echo "\`\`\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "### Universal
